# MultipleShell ç›‘æ§æ–¹æ¡ˆï¼šç¼©ç•¥å›¾æ¨¡å¼ç›‘æµ‹ä¸‰å¤§ç±»å‹æ‰§è¡ŒçŠ¶æ€

## æ¦‚è¿°

æœ¬æ–¹æ¡ˆæä¾›ä¸€ä¸ªç¼©ç•¥å›¾ç›‘æ§æ¨¡å¼ï¼Œç”¨äºå®æ—¶ç›‘æµ‹ä¸‰ç§ Shell ç±»å‹ï¼ˆClaude Codeã€Codexã€OpenCodeï¼‰çš„æ‰§è¡Œå®ŒæˆçŠ¶æ€ã€‚

## ä¸€ã€ç›‘æ§å¯è¡Œæ€§åˆ†æ

### âœ… å¯ä»¥ç›‘æµ‹çš„å†…å®¹

1. **è¿›ç¨‹çŠ¶æ€ç›‘æ§**
   - PTY è¿›ç¨‹æ˜¯å¦å­˜åœ¨
   - è¿›ç¨‹é€€å‡ºç ï¼ˆæ­£å¸¸/å¼‚å¸¸é€€å‡ºï¼‰
   - è¿›ç¨‹è¿è¡Œæ—¶é•¿

2. **è¾“å‡ºæµç›‘æ§**
   - ç»ˆç«¯è¾“å‡ºå†…å®¹å®æ—¶æ•è·
   - å…³é”®å­—åŒ¹é…ï¼ˆæˆåŠŸ/å¤±è´¥/é”™è¯¯æ ‡è¯†ï¼‰
   - è¾“å‡ºè¡Œæ•°ç»Ÿè®¡

3. **é…ç½®çŠ¶æ€ç›‘æ§**
   - é…ç½®æ–‡ä»¶åŠ è½½çŠ¶æ€
   - ç¯å¢ƒå˜é‡è®¾ç½®çŠ¶æ€
   - ä¸´æ—¶ç›®å½•åˆ›å»ºçŠ¶æ€

4. **ä¼šè¯æ´»åŠ¨ç›‘æ§**
   - æœ€åæ´»åŠ¨æ—¶é—´
   - ç”¨æˆ·è¾“å…¥é¢‘ç‡
   - å‘½ä»¤æ‰§è¡Œæ¬¡æ•°

### âš ï¸ éš¾ä»¥ç›‘æµ‹çš„å†…å®¹

1. **AI å·¥å…·å†…éƒ¨çŠ¶æ€**
   - Claude Code/Codex/OpenCode çš„å†…éƒ¨ä»»åŠ¡é˜Ÿåˆ—
   - AI æ¨¡å‹å“åº”è¿›åº¦
   - å…·ä½“ä»»åŠ¡å®Œæˆç™¾åˆ†æ¯”

2. **è¯­ä¹‰çº§åˆ«çš„"å®Œæˆ"**
   - éœ€è¦è§£æ AI å·¥å…·çš„ç‰¹å®šè¾“å‡ºæ ¼å¼
   - ä¸åŒå·¥å…·çš„å®Œæˆæ ‡è¯†ä¸ç»Ÿä¸€

## äºŒã€ç›‘æ§æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç¼©ç•¥å›¾ç›‘æ§é¢æ¿                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚Claude Codeâ”‚  â”‚  Codex   â”‚  â”‚ OpenCode â”‚              â”‚
â”‚  â”‚  [è¿è¡Œä¸­] â”‚  â”‚  [å®Œæˆ]  â”‚  â”‚  [é”™è¯¯]  â”‚              â”‚
â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘  â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†‘
                   ç›‘æ§æ•°æ®æ”¶é›†
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Shell ç›‘æ§æœåŠ¡ (æ–°å¢)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  - è¾“å‡ºæµè§£æå™¨ (Output Parser)                  â”‚   â”‚
â”‚  â”‚  - çŠ¶æ€æ£€æµ‹å™¨ (Status Detector)                  â”‚   â”‚
â”‚  â”‚  - äº‹ä»¶èšåˆå™¨ (Event Aggregator)                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†‘
                   æ•°æ®æº (ç°æœ‰)
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PTY Manager + Terminal Sessions                        â”‚
â”‚  - è¿›ç¨‹äº‹ä»¶ (exit, data, error)                         â”‚
â”‚  - è¾“å‡ºæµæ•°æ® (stdout/stderr)                           â”‚
â”‚  - ä¼šè¯å…ƒæ•°æ® (sessionId, configType, startTime)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸‰ã€ç›‘æ§æŒ‡æ ‡å®šä¹‰

### 3.1 åŸºç¡€çŠ¶æ€

| çŠ¶æ€ | å›¾æ ‡ | é¢œè‰² | è§¦å‘æ¡ä»¶ |
|------|------|------|----------|
| æœªå¯åŠ¨ | âšª | ç°è‰² | ä¼šè¯æœªåˆ›å»º |
| å¯åŠ¨ä¸­ | ğŸ”µ | è“è‰² | è¿›ç¨‹å·²åˆ›å»ºï¼Œç­‰å¾…é¦–æ¬¡è¾“å‡º |
| è¿è¡Œä¸­ | ğŸŸ¢ | ç»¿è‰² | è¿›ç¨‹æ´»è·ƒï¼Œæœ‰è¾“å‡ºæµåŠ¨ |
| ç©ºé—² | ğŸŸ¡ | é»„è‰² | è¿›ç¨‹å­˜åœ¨ï¼Œä½† 30 ç§’æ— è¾“å‡º |
| å®Œæˆ | âœ… | ç»¿è‰² | æ£€æµ‹åˆ°å®Œæˆæ ‡è¯† |
| é”™è¯¯ | ğŸ”´ | çº¢è‰² | è¿›ç¨‹å¼‚å¸¸é€€å‡ºæˆ–é”™è¯¯è¾“å‡º |
| å·²åœæ­¢ | âš« | é»‘è‰² | è¿›ç¨‹æ­£å¸¸é€€å‡º |

### 3.2 ä¸‰å¤§ç±»å‹çš„å®Œæˆæ ‡è¯†

#### Claude Code
```javascript
completionPatterns: [
  /Task completed successfully/i,
  /âœ“ Done/i,
  /All tests passed/i,
  /Build succeeded/i,
  // æ£€æµ‹ PowerShell æç¤ºç¬¦è¿”å›ï¼ˆæ— æ´»åŠ¨çŠ¶æ€ï¼‰
  /PS\s+[A-Z]:\\/
]
```

#### Codex
```javascript
completionPatterns: [
  /Codex session ended/i,
  /Operation completed/i,
  /âœ“/,
  // æ£€æµ‹å‘½ä»¤æ‰§è¡Œå®Œæˆ
  /Exit code:\s*0/i
]
```

#### OpenCode
```javascript
completionPatterns: [
  /OpenCode task finished/i,
  /Successfully completed/i,
  /âœ“ All operations done/i
]
```

### 3.3 é”™è¯¯æ ‡è¯†

```javascript
errorPatterns: [
  /error:/i,
  /failed/i,
  /exception/i,
  /fatal/i,
  /cannot find/i,
  /permission denied/i,
  /timeout/i,
  /Exit code:\s*[1-9]/i  // éé›¶é€€å‡ºç 
]
```

## å››ã€å®ç°æ–¹æ¡ˆ

### 4.1 æ–°å¢æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ main/
â”‚   â””â”€â”€ shell-monitor.js          # æ–°å¢ï¼šShell ç›‘æ§æœåŠ¡
â”œâ”€â”€ renderer/
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ MonitorPanel.vue      # æ–°å¢ï¼šç¼©ç•¥å›¾ç›‘æ§é¢æ¿
â”‚       â””â”€â”€ SessionThumbnail.vue  # æ–°å¢ï¼šå•ä¸ªä¼šè¯ç¼©ç•¥å›¾
â””â”€â”€ shared/
    â””â”€â”€ monitor-constants.js      # æ–°å¢ï¼šç›‘æ§å¸¸é‡å®šä¹‰
```

### 4.2 æ ¸å¿ƒä»£ç å®ç°

#### 4.2.1 Shell ç›‘æ§æœåŠ¡ (`shell-monitor.js`)

```javascript
class ShellMonitor {
  constructor() {
    this.sessions = new Map(); // sessionId -> MonitorState
    this.outputBuffers = new Map(); // sessionId -> æœ€è¿‘è¾“å‡ºç¼“å†²
  }

  // æ³¨å†Œä¼šè¯ç›‘æ§
  registerSession(sessionId, configType) {
    this.sessions.set(sessionId, {
      sessionId,
      configType,
      status: 'starting',
      startTime: Date.now(),
      lastActivityTime: Date.now(),
      outputLineCount: 0,
      errorCount: 0,
      completionDetected: false,
      processExitCode: null
    });
  }

  // å¤„ç†è¾“å‡ºæ•°æ®
  onData(sessionId, data) {
    const state = this.sessions.get(sessionId);
    if (!state) return;

    // æ›´æ–°æ´»åŠ¨æ—¶é—´
    state.lastActivityTime = Date.now();
    state.outputLineCount += data.split('\n').length;

    // ç¼“å†²æœ€è¿‘ 1000 è¡Œè¾“å‡ºç”¨äºæ¨¡å¼åŒ¹é…
    let buffer = this.outputBuffers.get(sessionId) || '';
    buffer += data;
    buffer = buffer.split('\n').slice(-1000).join('\n');
    this.outputBuffers.set(sessionId, buffer);

    // æ£€æµ‹å®Œæˆæ ‡è¯†
    if (this.detectCompletion(state.configType, buffer)) {
      state.status = 'completed';
      state.completionDetected = true;
    }

    // æ£€æµ‹é”™è¯¯
    if (this.detectError(buffer)) {
      state.errorCount++;
      if (state.errorCount > 3) {
        state.status = 'error';
      }
    }

    // æ›´æ–°è¿è¡ŒçŠ¶æ€
    if (state.status === 'starting') {
      state.status = 'running';
    }

    // é€šçŸ¥æ¸²æŸ“è¿›ç¨‹
    this.notifyUpdate(sessionId);
  }

  // å¤„ç†è¿›ç¨‹é€€å‡º
  onExit(sessionId, exitCode) {
    const state = this.sessions.get(sessionId);
    if (!state) return;

    state.processExitCode = exitCode;

    if (exitCode === 0) {
      state.status = state.completionDetected ? 'completed' : 'stopped';
    } else {
      state.status = 'error';
    }

    this.notifyUpdate(sessionId);
  }

  // æ£€æµ‹å®Œæˆæ¨¡å¼
  detectCompletion(configType, output) {
    const patterns = COMPLETION_PATTERNS[configType] || [];
    return patterns.some(pattern => pattern.test(output));
  }

  // æ£€æµ‹é”™è¯¯æ¨¡å¼
  detectError(output) {
    return ERROR_PATTERNS.some(pattern => pattern.test(output));
  }

  // æ£€æµ‹ç©ºé—²çŠ¶æ€
  checkIdleSessions() {
    const now = Date.now();
    for (const [sessionId, state] of this.sessions) {
      if (state.status === 'running') {
        const idleTime = now - state.lastActivityTime;
        if (idleTime > 30000) { // 30 ç§’æ— æ´»åŠ¨
          state.status = 'idle';
          this.notifyUpdate(sessionId);
        }
      }
    }
  }

  // é€šçŸ¥æ¸²æŸ“è¿›ç¨‹æ›´æ–°
  notifyUpdate(sessionId) {
    const state = this.sessions.get(sessionId);
    if (state && global.mainWindow) {
      global.mainWindow.webContents.send('monitor:update', {
        sessionId,
        state: { ...state }
      });
    }
  }

  // è·å–æ‰€æœ‰ä¼šè¯çŠ¶æ€
  getAllStates() {
    return Array.from(this.sessions.values());
  }
}

module.exports = new ShellMonitor();
```

#### 4.2.2 ç›‘æ§é¢æ¿ç»„ä»¶ (`MonitorPanel.vue`)

```vue
<template>
  <div class="monitor-panel" :class="{ collapsed: isCollapsed }">
    <div class="panel-header">
      <h3>{{ $t('monitor.title') }}</h3>
      <button @click="toggleCollapse">
        {{ isCollapsed ? 'â–¼' : 'â–²' }}
      </button>
    </div>

    <div v-if="!isCollapsed" class="thumbnails-grid">
      <SessionThumbnail
        v-for="session in sessions"
        :key="session.sessionId"
        :session="session"
        @click="focusSession(session.sessionId)"
      />
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div v-if="!isCollapsed" class="stats">
      <span>è¿è¡Œä¸­: {{ runningCount }}</span>
      <span>å®Œæˆ: {{ completedCount }}</span>
      <span>é”™è¯¯: {{ errorCount }}</span>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue';
import SessionThumbnail from './SessionThumbnail.vue';

const sessions = ref([]);
const isCollapsed = ref(false);

const runningCount = computed(() =>
  sessions.value.filter(s => s.status === 'running').length
);

const completedCount = computed(() =>
  sessions.value.filter(s => s.status === 'completed').length
);

const errorCount = computed(() =>
  sessions.value.filter(s => s.status === 'error').length
);

// ç›‘å¬ç›‘æ§æ›´æ–°
const handleMonitorUpdate = (event, { sessionId, state }) => {
  const index = sessions.value.findIndex(s => s.sessionId === sessionId);
  if (index >= 0) {
    sessions.value[index] = state;
  } else {
    sessions.value.push(state);
  }
};

// èšç„¦åˆ°æŒ‡å®šä¼šè¯
const focusSession = (sessionId) => {
  window.electronAPI.focusSession(sessionId);
};

const toggleCollapse = () => {
  isCollapsed.value = !isCollapsed.value;
};

onMounted(() => {
  window.electronAPI.on('monitor:update', handleMonitorUpdate);
  // è¯·æ±‚åˆå§‹çŠ¶æ€
  window.electronAPI.getMonitorStates().then(states => {
    sessions.value = states;
  });
});

onUnmounted(() => {
  window.electronAPI.off('monitor:update', handleMonitorUpdate);
});
</script>

<style scoped>
.monitor-panel {
  position: fixed;
  bottom: 0;
  right: 0;
  width: 400px;
  background: rgba(30, 30, 30, 0.95);
  border: 1px solid #444;
  border-radius: 8px 8px 0 0;
  padding: 10px;
  z-index: 1000;
  transition: height 0.3s ease;
}

.monitor-panel.collapsed {
  height: 40px;
  overflow: hidden;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.thumbnails-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 10px;
  max-height: 300px;
  overflow-y: auto;
}

.stats {
  display: flex;
  justify-content: space-around;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #444;
  font-size: 12px;
}
</style>
```

#### 4.2.3 ä¼šè¯ç¼©ç•¥å›¾ç»„ä»¶ (`SessionThumbnail.vue`)

```vue
<template>
  <div
    class="session-thumbnail"
    :class="[`status-${session.status}`, session.configType]"
    :title="tooltipText"
  >
    <div class="thumbnail-header">
      <span class="status-icon">{{ statusIcon }}</span>
      <span class="config-type">{{ session.configType }}</span>
    </div>

    <div class="thumbnail-body">
      <div class="progress-bar" v-if="showProgress">
        <div
          class="progress-fill"
          :style="{ width: progressPercent + '%' }"
        ></div>
      </div>

      <div class="stats-mini">
        <span>{{ formatDuration(session.startTime) }}</span>
        <span>{{ session.outputLineCount }} è¡Œ</span>
      </div>
    </div>

    <div class="thumbnail-footer" v-if="session.errorCount > 0">
      <span class="error-badge">{{ session.errorCount }} é”™è¯¯</span>
    </div>
  </div>
</template>

<script setup>
import { computed } from 'vue';

const props = defineProps({
  session: {
    type: Object,
    required: true
  }
});

const statusIcon = computed(() => {
  const icons = {
    'unstarted': 'âšª',
    'starting': 'ğŸ”µ',
    'running': 'ğŸŸ¢',
    'idle': 'ğŸŸ¡',
    'completed': 'âœ…',
    'error': 'ğŸ”´',
    'stopped': 'âš«'
  };
  return icons[props.session.status] || 'â“';
});

const showProgress = computed(() => {
  return ['starting', 'running', 'idle'].includes(props.session.status);
});

const progressPercent = computed(() => {
  // åŸºäºè¾“å‡ºè¡Œæ•°çš„ç®€å•è¿›åº¦ä¼°ç®—
  // å®é™…åº”ç”¨ä¸­å¯ä»¥æ ¹æ®å…·ä½“å·¥å…·è°ƒæ•´
  const lines = props.session.outputLineCount;
  return Math.min(100, (lines / 100) * 100);
});

const tooltipText = computed(() => {
  return `${props.session.configType} - ${props.session.status}\n` +
         `è¿è¡Œæ—¶é•¿: ${formatDuration(props.session.startTime)}\n` +
         `è¾“å‡ºè¡Œæ•°: ${props.session.outputLineCount}\n` +
         `é”™è¯¯æ•°: ${props.session.errorCount}`;
});

const formatDuration = (startTime) => {
  const duration = Date.now() - startTime;
  const seconds = Math.floor(duration / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);

  if (hours > 0) return `${hours}h ${minutes % 60}m`;
  if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
  return `${seconds}s`;
};
</script>

<style scoped>
.session-thumbnail {
  border: 2px solid #444;
  border-radius: 6px;
  padding: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  background: #2a2a2a;
}

.session-thumbnail:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.status-running { border-color: #4caf50; }
.status-completed { border-color: #8bc34a; background: #1b5e20; }
.status-error { border-color: #f44336; background: #b71c1c; }
.status-idle { border-color: #ffc107; }

.thumbnail-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.status-icon {
  font-size: 20px;
}

.config-type {
  font-size: 10px;
  font-weight: bold;
  text-transform: uppercase;
  color: #aaa;
}

.progress-bar {
  height: 4px;
  background: #444;
  border-radius: 2px;
  overflow: hidden;
  margin: 6px 0;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #4caf50, #8bc34a);
  transition: width 0.3s ease;
}

.stats-mini {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: #888;
}

.thumbnail-footer {
  margin-top: 6px;
  padding-top: 6px;
  border-top: 1px solid #444;
}

.error-badge {
  font-size: 10px;
  color: #f44336;
  font-weight: bold;
}
</style>
```

### 4.3 é›†æˆåˆ°ç°æœ‰ä»£ç 

#### ä¿®æ”¹ `pty-manager.js`

```javascript
const shellMonitor = require('./shell-monitor');

class PTYManager {
  createSession(sessionId, config, workingDirectory) {
    // ... ç°æœ‰ä»£ç  ...

    // æ³¨å†Œç›‘æ§
    shellMonitor.registerSession(sessionId, config.type);

    // ç›‘å¬è¾“å‡º
    ptyProcess.onData((data) => {
      // ... ç°æœ‰ä»£ç  ...
      shellMonitor.onData(sessionId, data);
    });

    // ç›‘å¬é€€å‡º
    ptyProcess.onExit(({ exitCode }) => {
      // ... ç°æœ‰ä»£ç  ...
      shellMonitor.onExit(sessionId, exitCode);
    });
  }
}
```

#### ä¿®æ”¹ `main/index.js` æ·»åŠ  IPC å¤„ç†

```javascript
const shellMonitor = require('./shell-monitor');

// è·å–æ‰€æœ‰ç›‘æ§çŠ¶æ€
ipcMain.handle('get-monitor-states', () => {
  return shellMonitor.getAllStates();
});

// èšç„¦åˆ°æŒ‡å®šä¼šè¯
ipcMain.handle('focus-session', (event, sessionId) => {
  mainWindow.webContents.send('focus-tab', sessionId);
});

// å®šæœŸæ£€æŸ¥ç©ºé—²ä¼šè¯
setInterval(() => {
  shellMonitor.checkIdleSessions();
}, 5000);
```

## äº”ã€ä½¿ç”¨åœºæ™¯

### 5.1 å¼€å‘è°ƒè¯•åœºæ™¯
- åŒæ—¶è¿è¡Œå¤šä¸ª AI å·¥å…·è¿›è¡Œå¯¹æ¯”æµ‹è¯•
- å®æ—¶ç›‘æ§å“ªä¸ªå·¥å…·å…ˆå®Œæˆä»»åŠ¡
- å¿«é€Ÿå®šä½å‡ºé”™çš„ä¼šè¯

### 5.2 æ‰¹é‡ä»»åŠ¡åœºæ™¯
- å¯åŠ¨å¤šä¸ªé…ç½®æ‰§è¡Œæ‰¹é‡æ“ä½œ
- é€šè¿‡ç¼©ç•¥å›¾å¿«é€ŸæŸ¥çœ‹æ•´ä½“è¿›åº¦
- å®Œæˆåè‡ªåŠ¨é€šçŸ¥

### 5.3 é•¿æ—¶é—´è¿è¡Œåœºæ™¯
- ç›‘æ§é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡çŠ¶æ€
- æ£€æµ‹ç©ºé—²æˆ–å¡æ­»çš„ä¼šè¯
- è‡ªåŠ¨è®°å½•å®Œæˆæ—¶é—´

## å…­ã€æ‰©å±•åŠŸèƒ½å»ºè®®

### 6.1 é«˜çº§ç›‘æ§
- **è¾“å‡ºæ—¥å¿—è®°å½•**: ä¿å­˜æ¯ä¸ªä¼šè¯çš„å®Œæ•´è¾“å‡ºåˆ°æ–‡ä»¶
- **æ€§èƒ½æŒ‡æ ‡**: CPU/å†…å­˜ä½¿ç”¨ç‡ç›‘æ§
- **ç½‘ç»œç›‘æ§**: API è°ƒç”¨æ¬¡æ•°å’Œå“åº”æ—¶é—´

### 6.2 æ™ºèƒ½åˆ†æ
- **AI è¾“å‡ºè§£æ**: ä½¿ç”¨æ­£åˆ™æˆ– AI è§£æå·¥å…·çš„ç»“æ„åŒ–è¾“å‡º
- **ä»»åŠ¡è¿›åº¦ä¼°ç®—**: åŸºäºå†å²æ•°æ®é¢„æµ‹å®Œæˆæ—¶é—´
- **å¼‚å¸¸æ£€æµ‹**: è¯†åˆ«å¼‚å¸¸è¾“å‡ºæ¨¡å¼

### 6.3 é€šçŸ¥ç³»ç»Ÿ
- **æ¡Œé¢é€šçŸ¥**: ä»»åŠ¡å®Œæˆæˆ–å‡ºé”™æ—¶å¼¹å‡ºé€šçŸ¥
- **å£°éŸ³æç¤º**: ä¸åŒçŠ¶æ€ä½¿ç”¨ä¸åŒæç¤ºéŸ³
- **é‚®ä»¶/Webhook**: é›†æˆå¤–éƒ¨é€šçŸ¥æ¸ é“

### 6.4 å¯è§†åŒ–å¢å¼º
- **å®æ—¶è¾“å‡ºé¢„è§ˆ**: ç¼©ç•¥å›¾æ˜¾ç¤ºæœ€åå‡ è¡Œè¾“å‡º
- **å›¾è¡¨ç»Ÿè®¡**: æ˜¾ç¤ºå†å²ä»»åŠ¡å®Œæˆç‡ã€å¹³å‡æ—¶é•¿ç­‰
- **çƒ­åŠ›å›¾**: æ˜¾ç¤ºä¸åŒæ—¶é—´æ®µçš„æ´»åŠ¨å¼ºåº¦

## ä¸ƒã€æŠ€æœ¯æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ

### 7.1 æŒ‘æˆ˜ï¼šä¸åŒå·¥å…·è¾“å‡ºæ ¼å¼ä¸ç»Ÿä¸€
**è§£å†³æ–¹æ¡ˆ**:
- ä¸ºæ¯ç§å·¥å…·å®šä¹‰ç‹¬ç«‹çš„æ¨¡å¼åŒ¹é…è§„åˆ™
- æä¾›ç”¨æˆ·è‡ªå®šä¹‰æ¨¡å¼çš„é…ç½®é€‰é¡¹
- ä½¿ç”¨æœºå™¨å­¦ä¹ è¯†åˆ«å¸¸è§å®Œæˆæ¨¡å¼

### 7.2 æŒ‘æˆ˜ï¼šå¤§é‡è¾“å‡ºå¯¼è‡´æ€§èƒ½é—®é¢˜
**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨æ»‘åŠ¨çª—å£ç¼“å†²ï¼ˆåªä¿ç•™æœ€è¿‘ 1000 è¡Œï¼‰
- å¼‚æ­¥å¤„ç†è¾“å‡ºæ•°æ®ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
- ä½¿ç”¨ Web Worker è¿›è¡Œæ¨¡å¼åŒ¹é…

### 7.3 æŒ‘æˆ˜ï¼šæ— æ³•å‡†ç¡®åˆ¤æ–­"å®Œæˆ"
**è§£å†³æ–¹æ¡ˆ**:
- ç»“åˆå¤šä¸ªæŒ‡æ ‡ç»¼åˆåˆ¤æ–­ï¼ˆè¿›ç¨‹é€€å‡º + è¾“å‡ºæ¨¡å¼ + ç©ºé—²æ—¶é—´ï¼‰
- æä¾›æ‰‹åŠ¨æ ‡è®°å®Œæˆçš„åŠŸèƒ½
- å­¦ä¹ ç”¨æˆ·çš„æ ‡è®°è¡Œä¸ºï¼Œä¼˜åŒ–è‡ªåŠ¨æ£€æµ‹

## å…«ã€å®æ–½æ­¥éª¤

1. **ç¬¬ä¸€é˜¶æ®µ**: å®ç°åŸºç¡€ç›‘æ§æœåŠ¡å’Œæ•°æ®æ”¶é›†
2. **ç¬¬äºŒé˜¶æ®µ**: å¼€å‘ç¼©ç•¥å›¾ UI ç»„ä»¶
3. **ç¬¬ä¸‰é˜¶æ®µ**: é›†æˆåˆ°ç°æœ‰ PTY ç®¡ç†å™¨
4. **ç¬¬å››é˜¶æ®µ**: æ·»åŠ å®Œæˆæ£€æµ‹é€»è¾‘
5. **ç¬¬äº”é˜¶æ®µ**: ä¼˜åŒ–æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ
6. **ç¬¬å…­é˜¶æ®µ**: æ·»åŠ é«˜çº§åŠŸèƒ½ï¼ˆé€šçŸ¥ã€æ—¥å¿—ç­‰ï¼‰

## ä¹ã€æ€»ç»“

**å¯è¡Œæ€§**: âœ… é«˜åº¦å¯è¡Œ

é€šè¿‡ç›‘æ§è¿›ç¨‹çŠ¶æ€ã€è¾“å‡ºæµå’Œç‰¹å®šæ¨¡å¼ï¼Œå¯ä»¥æœ‰æ•ˆç›‘æµ‹ä¸‰ç§ Shell ç±»å‹çš„æ‰§è¡ŒçŠ¶æ€ã€‚è™½ç„¶æ— æ³• 100% å‡†ç¡®åˆ¤æ–­ AI å·¥å…·çš„å†…éƒ¨å®ŒæˆçŠ¶æ€ï¼Œä½†é€šè¿‡ç»¼åˆå¤šä¸ªæŒ‡æ ‡å¯ä»¥è¾¾åˆ° 80-90% çš„å‡†ç¡®ç‡ã€‚

**æ ¸å¿ƒä¼˜åŠ¿**:
- å®æ—¶å¯è§†åŒ–å¤šä¸ªä¼šè¯çŠ¶æ€
- å¿«é€Ÿå®šä½é—®é¢˜ä¼šè¯
- æå‡å¤šä»»åŠ¡ç®¡ç†æ•ˆç‡

**å»ºè®®ä¼˜å…ˆçº§**:
1. åŸºç¡€çŠ¶æ€ç›‘æ§ï¼ˆè¿›ç¨‹ã€è¾“å‡ºï¼‰
2. ç¼©ç•¥å›¾ UI å®ç°
3. å®Œæˆæ£€æµ‹é€»è¾‘
4. é€šçŸ¥å’Œæ—¥å¿—åŠŸèƒ½
